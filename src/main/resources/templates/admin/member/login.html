<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="admin/layout/basic">
<th:block layout:fragment="title">
  <title>로그인 페이지</title>
</th:block>

<th:block layout:fragment="content">

  <section id="container">

    <div id="login_wrap">
      <div id="login_box">
        <div class="login_con">
          <div class="login_tit">
            <h2>ADMIN</h2>
            <p>LOG<i>IN</i></p>
          </div>

          <div class="login_input">
            <form id="loginForm" onsubmit="return false;" autocomplete="off">
              <ul>
                <li>
                  <label for="loginId" class="skip_info">아이디</label>
                  <input type="text" id="loginId" name="loginId" placeholder="아이디" title="아이디" />
                </li>
                <li>
                  <label for="password" class="skip_info">비밀번호</label>
                  <input type="password" id="password" name="password" title="비밀번호" placeholder="비밀번호" />
                </li>
              </ul>
              <button type="button" onclick="login();" class="login_btn">로그인</button>
              <button type="button" onclick="openSignupPopup();" class="signup_btn">회원가입</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!--/* 회원가입 popup */-->
    <div id="signupPopup" class="popLayer">
      <h3>회원가입</h3>
      <div class="pop_container">
        <form id="signupForm" onsubmit="return false;" autocomplete="off">
          <table class="tb tb_row tl">
            <colgroup>
              <col style="width:30%;" /><col style="width:70%;" />
            </colgroup>
            <tbody>
            <tr>
              <th scope="row">아이디<span class="es">필수 입력</span></th>
              <td>
                <input type="text" name="signUpId" placeholder="아이디" maxlength="20" style="width: 70%;" />
                <button type="button" id="idCheckBtn" class="btns btn_st5" onclick="checkSignUpId();" style="width: auto; float: right;">중복확인</button>
              </td>
            </tr>
            <tr>
              <th scope="row">비밀번호<span class="es">필수 입력</span></th>
              <td><input type="password" name="password" placeholder="비밀번호" maxlength="30" /></td>
            </tr>
            <tr>
              <th scope="row">비밀번호 재입력<span class="es">필수 입력</span></th>
              <td><input type="password" name="passwordCheck" placeholder="비밀번호 재입력" maxlength="30" /></td>
            </tr>
            <tr>
              <th scope="row">이름<span class="es">필수 입력</span></th>
              <td><input type="text" name="name" placeholder="이름" maxlength="10" /></td>
            </tr>

            <tr>
              <th scope="row">휴대폰번호<span class="es">필수 입력</span></th>
              <td><input type="text" name="htel" placeholder="'-' 없이 입력" /></td>
            </tr>
            </tbody>
          </table>
        </form>
        <p class="btn_set">
          <button type="button" class="btns btn_st4" onclick="saveMember();">가입</button>
          <button type="button" class="btns btn_st1" onclick="closeSignupPopup();">취소</button>
        </p>
      </div>
      <button type="button" class="btn_close" onclick="closeSignupPopup();"><span><i class="far fa-times-circle"></i></span></button>
    </div>

  </section>
</th:block>

<th:block layout:fragment="script">
  <script th:inline="javascript">

    function openSignupPopup() {
        layerPop('signupPopup')
    }

    function closeSignupPopup() {
        const form = document.getElementById('signupForm');
        form.signUpId.readOnly = false;
        form.querySelector('#idCheckBtn').disabled = false;
        form.reset();
        layerPopClose();
    }

    // 회원가입 아이디 중복 체크
    function checkSignUpId() {

      const form = document.getElementById('signupForm');
      const fields = [form.signUpId];
      const fieldNames = ['아이디'];
      const signUpId = $("input[name='signUpId']");

      //유효성 검사
      for (let i = 0, len = fields.length; i < len; i++) {
          isValid(fields[i], fieldNames[i]);
      }

      const count = $.getJSON('/member-count', {
        signUpId : signUpId.value
      });

      if (count > 0) {
          alert('이미 가입된 아이디가 있습니다.');
          signUpId.focus();
          return false;
      }

      if (confirm('사용 가능한 아이디입니다.\n입력하신 아이디로 결정하시겠어요?')) {
          signUpId.readOnly = true;
          document.getElementById('idCheckBtn').disabled = true;
      }
    }

    // 회원 정보 저장 (회원가입)
    function saveMember() {

      const form = document.getElementById('signupForm');
      validationMemberInfo(form);

      const params = {}
      new FormData(form).forEach((value, key) => params[key] = value.trim());
      params.birthday = params.birthday.replace(/(\d{4})(\d{2})(\d{2})/g, '$1-$2-$3');

      callApi('/members', 'post', params);
      alert('가입을 축하드립니다!\n로그인 후 서비스를 이용해 주세요.');
      closeSignupPopup();
    }

    // 회원 정보 유효성 검사
    function validationMemberInfo(form) {

      const fields = form.querySelectorAll('input:not([type="radio"])');
      const fieldNames = ['아이디', '비밀번호', '비밀번호 재입력', '이름', '휴대폰번호'];

      for (let i = 0, len = fields.length; i < len; i++) {
          isValid(fields[i], fieldNames[i]);
      }

      if (form.signUpId.readOnly === false) {
          alert('아이디 중복 체크를 완료해 주세요.');
          throw new Error();
      }

      if (form.password.value !== form.passwordCheck.value) {
          alert('비밀번호가 일치하지 않습니다.');
          form.passwordCheck.focus();
          throw new Error();
      }
    }
  </script>
</th:block>